<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Studio | PosterBox</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Lobster&family=Montserrat:wght@700&family=Oswald:wght@500&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-app: #f3f4f6; --bg-panel: #ffffff;
            --primary: #4f46e5; --primary-hover: #4338ca;
            --text-main: #111827; --text-muted: #6b7280;
            --border: #e5e7eb; --danger: #ef4444; --success: #10b981;
        }

        * { box-sizing: border-box; }
        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg-app); height: 100vh; display: flex; overflow: hidden; color: var(--text-main); }

        /* --- 1. SIDEBAR RAIL --- */
        .rail { width: 70px; background: #1e1b4b; display: flex; flex-direction: column; align-items: center; padding: 20px 0; z-index: 50; }
        .rail-btn { width: 44px; height: 44px; border-radius: 12px; color: #a5b4fc; display: flex; align-items: center; justify-content: center; font-size: 1.4rem; margin-bottom: 15px; cursor: pointer; transition: 0.2s; position: relative; }
        .rail-btn:hover { background: rgba(255,255,255,0.1); color: white; }
        .rail-btn.active { background: var(--primary); color: white; box-shadow: 0 0 15px rgba(79, 70, 229, 0.4); }
        .rail-btn::after { content: attr(title); position: absolute; left: 60px; background: #111827; color: white; padding: 5px 10px; border-radius: 4px; font-size: 0.75rem; opacity: 0; pointer-events: none; transition: 0.2s; white-space: nowrap; z-index: 100; }
        .rail-btn:hover::after { opacity: 1; }

        /* --- 2. LAYOUT --- */
        .app-shell { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .view-section { display: none; height: 100%; flex-direction: column; }
        .view-section.active { display: flex; }

        /* --- VIEW 1: EDITOR STYLES --- */
        .top-bar { height: 60px; background: var(--bg-panel); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; z-index: 40; position: relative; }
        .campaign-name { font-size: 1.1rem; font-weight: 700; border: 1px solid transparent; background: transparent; color: var(--text-main); outline: none; width: 300px; padding: 5px; border-radius: 4px; transition: 0.2s; }
        .campaign-name:hover, .campaign-name:focus { border-color: var(--border); background: white; }
        .btn-primary { background: var(--primary); color: white; padding: 10px 20px; border-radius: 8px; font-weight: 600; border: none; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 8px; font-size: 0.9rem; }
        .btn-primary:hover { background: var(--primary-hover); transform: translateY(-1px); }

        .editor-body { flex: 1; display: flex; overflow: hidden; position: relative; }
        
        /* Panels */
        .panel-left { width: 260px; background: var(--bg-panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 20px; gap: 10px; overflow-y: auto; z-index: 30; }
        .panel-right { width: 280px; background: var(--bg-panel); border-left: 1px solid var(--border); padding: 20px; overflow-y: auto; z-index: 30; }
        .section-title { font-size: 0.75rem; text-transform: uppercase; font-weight: 700; color: var(--text-muted); margin-bottom: 8px; display: block; }
        
        .tool-btn { width: 100%; padding: 12px; background: white; border: 1px solid var(--border); border-radius: 8px; text-align: left; cursor: pointer; font-weight: 600; color: var(--text-main); display: flex; align-items: center; gap: 12px; transition: 0.2s; }
        .tool-btn:hover { border-color: var(--primary); color: var(--primary); background: #eef2ff; }

        /* Stage */
        .stage { 
            flex: 1; background: #e5e7eb; overflow: hidden; position: relative; 
            background-image: radial-gradient(#cbd5e1 1px, transparent 1px); background-size: 20px 20px; 
            cursor: grab;
        }
        .stage:active { cursor: grabbing; }

        .canvas-wrapper { transform-origin: center center; position: absolute; left: 50%; top: 50%; transition: transform 0.1s linear; }
        .artboard { width: 400px; height: 500px; background: white; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); position: relative; overflow: hidden; transform: translate(-50%, -50%); }
        .bg-layer { width: 100%; height: 100%; object-fit: cover; pointer-events: none; user-select: none; }
        
        /* Zoom Controls */
        .zoom-widget { position: absolute; bottom: 20px; right: 20px; background: white; padding: 5px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 5px; z-index: 40; }
        .zoom-btn { width: 30px; height: 30px; border: none; background: #f3f4f6; border-radius: 6px; cursor: pointer; font-weight: bold; color: var(--text-main); }
        .zoom-btn:hover { background: #e5e7eb; }
        .zoom-val { font-size: 0.85rem; font-weight: 600; width: 50px; text-align: center; }

        /* Elements */
        .el { position: absolute; cursor: default; border: 1px dashed var(--primary); display: flex; align-items: center; justify-content: center; box-sizing: border-box; }
        .el:hover { background: rgba(79, 70, 229, 0.05); }
        .el.selected { border: 2px solid var(--primary); z-index: 1000 !important; cursor: move; }
        .el-photo { background: rgba(0,0,0,0.05); font-size: 0.8rem; color: #9ca3af; font-weight: 700; text-transform: uppercase; overflow: hidden; }
        .el-text { border: 1px dotted transparent; white-space: nowrap; }
        .handle { width: 12px; height: 12px; background: var(--primary); border: 2px solid white; border-radius: 50%; position: absolute; bottom: -6px; right: -6px; cursor: se-resize; display: none; }
        .el.selected .handle { display: block; }

        /* Layers Panel */
        #layerList { display: flex; flex-direction: column; gap: 6px; margin-top: 10px; }
        .layer-item { display: flex; align-items: center; padding: 8px; background: white; border: 1px solid var(--border); border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 600; user-select: none; }
        .layer-item.active { border-color: var(--primary); background: #eef2ff; color: var(--primary); }
        .layer-item:active { cursor: grabbing; }

        /* Props */
        .input { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 0.9rem; margin-bottom: 10px; }
        .btn-group { display: flex; gap: 5px; margin-bottom: 10px; }
        .btn-icon { flex: 1; padding: 8px; background: white; border: 1px solid var(--border); border-radius: 6px; cursor: pointer; font-weight: 600; display: flex; justify-content: center; align-items: center; }
        .btn-icon.active { background: #eef2ff; border-color: var(--primary); color: var(--primary); }
        .btn-danger { width: 100%; padding: 10px; background: #fef2f2; color: var(--danger); border: 1px solid #fecaca; border-radius: 6px; font-weight: 600; cursor: pointer; margin-top: 20px; }
        .btn-dup { width: 100%; padding: 10px; background: white; color: var(--primary); border: 1px solid var(--primary); border-radius: 6px; font-weight: 600; cursor: pointer; margin-top: 20px; }

        /* View 2 & 3 */
        .manager-container { padding: 40px; flex: 1; overflow-y: auto; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 30px; }
        .camp-card { background: white; border: 1px solid var(--border); border-radius: 12px; overflow: hidden; position: relative; transition: 0.3s; }
        .camp-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        .card-img { height: 180px; background: #e5e7eb; overflow: hidden; position: relative; }
        .card-img img { width: 100%; height: 100%; object-fit: cover; }
        .status-badge { position: absolute; top: 10px; right: 10px; padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .st-active { color: var(--success); }
        .st-inactive { color: var(--text-muted); }
        .card-body { padding: 20px; }
        .card-title { font-weight: 700; font-size: 1.1rem; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .card-actions { display: flex; gap: 5px; border-top: 1px solid var(--border); padding-top: 15px; margin-top: 15px; }
        .btn-act { flex: 1; padding: 8px; border-radius: 6px; font-size: 0.8rem; font-weight: 600; cursor: pointer; border: 1px solid var(--border); background: white; transition: 0.2s; }
        .btn-act:hover { background: #f9fafb; }
        .btn-share { color: var(--primary); border-color: #e0e7ff; background: #eef2ff; }
        .btn-del { color: var(--danger); border-color: #fecaca; }
        
        .profile-box { max-width: 600px; background: white; border: 1px solid var(--border); border-radius: 12px; padding: 40px; margin: 0 auto; }
        .hidden { display: none; }
        .empty-msg { text-align: center; color: var(--text-muted); grid-column: 1 / -1; margin-top: 50px; }
    </style>
</head>
<body>

    <div class="rail">
        <div class="rail-btn" id="nav-editor" onclick="createNew()" title="Create New">üé®</div>
        <div class="rail-btn" id="nav-list" onclick="switchView('list')" title="My Campaigns">üìÇ</div>
        <div class="rail-btn" id="nav-profile" onclick="switchView('profile')" title="Account">üë§</div>
        
        <div class="rail-btn" style="margin-top:auto; color:#ef4444; font-size:1.2rem;" onclick="resetData()" title="Reset Data">üóëÔ∏è</div>
        <div class="rail-btn" style="" onclick="logout()" title="Log Out">üö™</div>
    </div>

    <div class="app-shell">
        
        <div id="view-list" class="view-section active">
            <div style="padding:20px 40px; background:white; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <h1 style="margin:0; font-size:1.8rem;">My Campaigns</h1>
                    <p style="margin:5px 0 0; color:var(--text-muted); font-size:0.9rem;">Manage your posters</p>
                </div>
                <button class="btn-primary" onclick="createNew()">
                    <span style="font-size:1.2rem;">+</span> Create New
                </button>
            </div>
            
            <div class="manager-container">
                <div id="campGrid" class="grid"></div>
            </div>
        </div>

        <div id="view-editor" class="view-section hidden">
            <header class="top-bar">
                <div style="display:flex; align-items:center; gap:10px;">
                    <span style="font-size:1.2rem;">üìù</span>
                    <input type="text" id="campTitle" value="Untitled Campaign" class="campaign-name" placeholder="Campaign Name">
                </div>
                <div style="display:flex; gap:10px;">
                    <button class="btn-icon" onclick="clearCanvas()" title="Clear">üóëÔ∏è</button>
                    <button class="btn-primary" onclick="launch()"><span id="btnLaunchText">üöÄ Launch</span></button>
                </div>
            </header>

            <div class="editor-body">
                <div class="panel-left">
                    <span class="section-title">Setup</span>
                    <button class="tool-btn" onclick="document.getElementById('bgUp').click()">üñºÔ∏è Background</button>
                    <input type="file" id="bgUp" hidden accept="image/*" onchange="uploadBg(event)">
                    
                    <div style="margin-top:10px;">
                        <label class="section-title">Description</label>
                        <textarea id="campDesc" class="input" rows="3" placeholder="Describe your campaign..."></textarea>
                    </div>

                    <span class="section-title" style="margin-top:10px;">Tools</span>
                    <button class="tool-btn" onclick="add('photo')">üì∑ Photo Box</button>
                    <button class="tool-btn" style="margin-top:5px;" onclick="add('text')">üì¢ Static Text</button>
                    <button class="tool-btn" style="margin-top:5px;" onclick="add('input')">‚úçÔ∏è User Input</button>
                    
                    <span class="section-title" style="margin-top:20px;">Layers</span>
                    <div id="layerList"></div>
                </div>

                <div class="stage" id="stageArea" onmousedown="startPan(event)">
                    <div id="canvasWrapper" class="canvas-wrapper">
                        <div id="artboard" class="artboard">
                            <img id="bgImg" src="" class="bg-layer" style="display:none;">
                        </div>
                    </div>
                    <div class="zoom-widget">
                        <button class="zoom-btn" onclick="zoom(-0.1)">-</button>
                        <div class="zoom-val" id="zoomVal">100%</div>
                        <button class="zoom-btn" onclick="zoom(0.1)">+</button>
                    </div>
                </div>

                <div class="panel-right">
                    <span class="section-title">Properties</span>
                    <div id="noSel" style="color:#9ca3af; font-size:0.9rem; padding:20px 0;">Select an element</div>
                    
                    <div id="props" class="hidden">
                        <label class="section-title">Opacity</label>
                        <input type="range" class="input" min="0" max="1" step="0.1" id="pOp" oninput="upd('op', this.value)">
                        
                        <div id="propsShape" class="hidden">
                            <label class="section-title">Fill Color</label>
                            <input type="color" id="pFill" class="input" style="height:40px; padding:2px;" oninput="upd('fill', this.value)">

                            <label class="section-title" style="margin-top:10px;">Shape</label>
                            <select id="pShape" class="input" onchange="upd('shape', this.value)">
                                <option value="rect">Rectangle</option>
                                <option value="circle">Circle</option>
                                <option value="round">Rounded</option>
                            </select>
                            <div id="radiusContainer">
                                <label class="section-title">Corner Radius</label>
                                <input type="range" class="input" min="0" max="50" value="0" id="pRadius" oninput="upd('radius', this.value)">
                            </div>
                        </div>

                        <div id="propsText" class="hidden">
                            <label class="section-title" id="lblText">Content</label>
                            <input type="text" id="pTxt" class="input" oninput="upd('text', this.value)">
                            
                            <label class="section-title">Typography</label>
                            <div style="display:flex; gap:5px; margin-bottom:10px;">
                                <select id="pFont" class="input" onchange="upd('font', this.value)" style="margin-bottom:0;">
                                    <option value="Inter">Inter</option>
                                    <option value="Montserrat">Montserrat</option>
                                    <option value="Oswald">Oswald</option>
                                    <option value="Lobster">Lobster</option>
                                </select>
                                <button class="btn-icon" onclick="document.getElementById('fontUp').click()">üìÇ</button>
                                <input type="file" id="fontUp" hidden accept=".ttf,.otf" onchange="uploadFont(event)">
                            </div>

                            <div class="btn-group">
                                <input type="color" id="pColor" class="input" style="height:38px; padding:2px;" oninput="upd('color', this.value)">
                                <input type="number" id="pSize" class="input" value="20" oninput="upd('size', this.value)">
                            </div>
                            
                            <div class="btn-group">
                                <button class="btn-icon" id="btnBold" onclick="toggleStyle('bold')"><b>B</b></button>
                                <button class="btn-icon" id="btnItalic" onclick="toggleStyle('italic')"><i>I</i></button>
                                <button class="btn-icon" id="btnShadow" onclick="toggleStyle('shadow')">S</button>
                            </div>
                            <div class="btn-group">
                                <button class="btn-icon" onclick="upd('align','left')">Left</button>
                                <button class="btn-icon" onclick="upd('align','center')">Center</button>
                                <button class="btn-icon" onclick="upd('align','right')">Right</button>
                            </div>
                        </div>

                        <button class="btn-dup" onclick="duplicate()">üìë Duplicate</button>
                        <button class="btn-danger" onclick="del()">üóëÔ∏è Delete</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-profile" class="view-section hidden">
            <div style="padding:30px 40px; background:white; border-bottom:1px solid var(--border);">
                <h1 style="margin:0; font-size:1.8rem;">Settings</h1>
            </div>
            <div class="manager-container">
                <div class="profile-box">
                    <label class="section-title">Name</label><input type="text" id="profName" class="input">
                    <label class="section-title">Email</label><input type="text" id="profEmail" class="input" readonly style="background:#f9fafb;">
                    <label class="section-title">Password</label><input type="password" id="profPass" class="input">
                    <button class="btn-primary" style="width:100%; justify-content:center;" onclick="saveProfile()">Save Changes</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        const user = JSON.parse(localStorage.getItem('clientAccount'));
        if (!user) window.location.href = 'login.html';
        
        let els = []; let selId = null; let editingId = null;
        let scale = 1; let panX = 0; let panY = 0; let isPanning = false; let pSX=0, pSY=0;

        // NAV
        function switchView(view) {
            document.querySelectorAll('.view-section').forEach(el => { el.classList.remove('active'); el.classList.add('hidden'); });
            document.querySelectorAll('.rail-btn').forEach(el => el.classList.remove('active'));
            
            document.getElementById('view-' + view).classList.remove('hidden');
            document.getElementById('view-' + view).classList.add('active');
            document.getElementById('nav-' + view).classList.add('active');
            
            if(view==='list') loadCampaigns();
            if(view==='profile') loadProfile();
        }
        
        // NEW FUNCTION FOR HEADER BUTTON
        function createNew() {
            resetEditorState();
            switchView('editor');
        }

        function logout() { localStorage.removeItem('isLoggedIn'); window.location.href = 'index.html'; }

        // ZOOM/PAN
        function zoom(d) { scale = Math.min(Math.max(.5, scale + d), 3); document.getElementById('zoomVal').innerText = Math.round(scale * 100) + '%'; applyTrf(); }
        function startPan(e) { if(e.target.classList.contains('stage')){ isPanning=true; pSX=e.clientX-panX; pSY=e.clientY-panY; document.getElementById('stageArea').style.cursor='grabbing'; document.addEventListener('mousemove', doPan); document.addEventListener('mouseup', stopPan); } }
        function doPan(e) { if(!isPanning) return; panX=e.clientX-pSX; panY=e.clientY-pSY; applyTrf(); }
        function stopPan() { isPanning=false; document.getElementById('stageArea').style.cursor='grab'; document.removeEventListener('mousemove', doPan); document.removeEventListener('mouseup', stopPan); }
        function applyTrf() { document.getElementById('canvasWrapper').style.transform = `translate(${panX}px, ${panY}px) scale(${scale})`; }

        // EDITOR
        function resetEditorState() {
            els=[]; selId=null; editingId=null; scale=1; panX=0; panY=0; applyTrf();
            document.getElementById('campTitle').value="Untitled Campaign";
            document.getElementById('campDesc').value="";
            document.getElementById('bgImg').src=""; document.getElementById('bgImg').style.display="none";
            document.getElementById('artboard').innerHTML='<img id="bgImg" src="" class="bg-layer" style="display:none;">';
            document.getElementById('props').classList.add('hidden'); document.getElementById('noSel').classList.remove('hidden');
            document.getElementById('btnLaunchText').innerText="üöÄ Launch";
            updateLayers();
        }

        function uploadBg(e) {
            const f=e.target.files[0]; if(!f)return;
            const r=new FileReader();
            r.onload=(ev)=>{ const img=new Image(); img.src=ev.target.result; img.onload=()=>{ const c=document.createElement('canvas'); const s=600/img.width; c.width=600; c.height=img.height*s; c.getContext('2d').drawImage(img,0,0,c.width,c.height); document.getElementById('bgImg').src=c.toDataURL('image/jpeg',0.6); document.getElementById('bgImg').style.display='block'; document.getElementById('artboard').style.width='450px'; document.getElementById('artboard').style.height=(450*(c.height/c.width))+'px'; } }
            r.readAsDataURL(f);
        }

        function uploadFont(e) {
            const f=e.target.files[0]; if(!f)return;
            const n=f.name.split('.')[0].replace(/[^a-zA-Z0-9]/g,'');
            const r=new FileReader();
            r.onload=(ev)=>{
                const face=new FontFace(n, `url(${ev.target.result})`);
                face.load().then(l=>{ document.fonts.add(l); const o=document.createElement('option'); o.text=n+" (Custom)"; o.value=n; document.getElementById('pFont').add(o); document.getElementById('pFont').value=n; upd('font',n); if(selId)els.find(x=>x.id===selId).customFontData=ev.target.result; });
            }
            r.readAsDataURL(f);
        }

        function add(type, copy=null) {
            const id='el_'+Date.now()+'_'+Math.floor(Math.random()*9999);
            const def={ 
                id, type, x:50, y:50, w:120, h:type==='photo'?120:50, 
                op:1, z:els.length+10, shape:'rect', radius:0, fill:'#e0e7ff', 
                text:type==='input'?'Name Here':'Text', placeholder:'Your Name', 
                font:'Inter', size:20, color:'#000', align:'center', bold:false, italic:false, shadow:false 
            };
            const d = copy ? {...copy, id, x:copy.x+20, y:copy.y+20, z:els.length+10} : def;
            els.push(d); render(d); select(id); updateLayers();
        }
        function duplicate(){ if(selId) add(null, els.find(x=>x.id===selId)); }

        function render(d) {
            const div=document.createElement('div'); div.id=d.id; div.className=d.type==='photo'?'el el-photo':'el el-text';
            applyCSS(div,d);
            div.innerHTML=d.type==='photo'?'Photo':(d.type==='input'?`[${d.placeholder}]`:d.text);
            const h=document.createElement('div'); h.className='handle'; div.appendChild(h);
            div.onmousedown=(e)=>drag(e,d.id); h.onmousedown=(e)=>resize(e,d.id);
            document.getElementById('artboard').appendChild(div);
        }

        function applyCSS(div,d) {
            div.style.left=d.x+'px'; div.style.top=d.y+'px'; div.style.width=d.w+'px'; div.style.height=d.h+'px'; div.style.zIndex=d.z; div.style.opacity=d.op;
            if(d.type==='photo') {
                div.style.borderRadius = d.shape==='circle'?'50%':(d.radius+'px');
                div.style.backgroundColor = d.fill || 'rgba(0,0,0,0.05)'; 
                div.style.color = '#333'; div.style.fontWeight = 'bold';
            } else { 
                div.style.fontFamily=d.font; div.style.fontSize=d.size+'px'; div.style.color=d.color; div.style.textAlign=d.align; 
                div.style.justifyContent=d.align==='left'?'flex-start':(d.align==='right'?'flex-end':'center'); 
                div.style.display='flex'; div.style.alignItems='center'; 
                div.style.fontWeight=d.bold?'bold':'normal'; div.style.fontStyle=d.italic?'italic':'normal'; 
                div.style.textShadow=d.shadow?'2px 2px 4px rgba(0,0,0,0.5)':'none'; 
            }
        }

        let isD=false, isR=false, sX,sY,sL,sT,sW,sH;
        function drag(e,id){ if(e.target.className.includes('handle'))return; e.preventDefault(); e.stopPropagation(); select(id); isD=true; sX=e.clientX; sY=e.clientY; const el=document.getElementById(id); sL=parseInt(el.style.left); sT=parseInt(el.style.top); document.addEventListener('mousemove', doD); document.addEventListener('mouseup', stop); }
        function doD(e){ if(!isD)return; const el=document.getElementById(selId), d=els.find(x=>x.id===selId); const dx=(e.clientX-sX)/scale; const dy=(e.clientY-sY)/scale; el.style.left=(sL+dx)+'px'; el.style.top=(sT+dy)+'px'; d.x=parseInt(el.style.left); d.y=parseInt(el.style.top); }
        function resize(e,id){ e.stopPropagation(); e.preventDefault(); isR=true; sX=e.clientX; sY=e.clientY; const el=document.getElementById(id); sW=parseInt(el.style.width); sH=parseInt(el.style.height); document.addEventListener('mousemove', doR); document.addEventListener('mouseup', stop); }
        function doR(e){ if(!isR)return; const el=document.getElementById(selId), d=els.find(x=>x.id===selId); const dx=(e.clientX-sX)/scale; const dy=(e.clientY-sY)/scale; el.style.width=Math.max(20,sW+dx)+'px'; el.style.height=Math.max(20,sH+dy)+'px'; d.w=parseInt(el.style.width); d.h=parseInt(el.style.height); }
        function stop(){ isD=false; isR=false; document.removeEventListener('mousemove', doD); document.removeEventListener('mousemove', doR); document.removeEventListener('mouseup', stop); }

        function select(id) {
            selId=id; document.querySelectorAll('.el').forEach(e=>e.classList.remove('selected')); 
            document.querySelectorAll('.layer-item').forEach(l=>l.classList.remove('active'));
            document.getElementById(id).classList.add('selected');
            const lItem=document.getElementById(`layer_${id}`); if(lItem)lItem.classList.add('active');
            
            const d=els.find(x=>x.id===id);
            document.getElementById('noSel').classList.add('hidden'); document.getElementById('props').classList.remove('hidden');
            document.getElementById('pOp').value=d.op;
            if(d.type==='photo') {
                document.getElementById('propsShape').classList.remove('hidden'); document.getElementById('propsText').classList.add('hidden');
                document.getElementById('pShape').value=d.shape; 
                document.getElementById('pFill').value = d.fill || '#e0e7ff'; 
                document.getElementById('radiusContainer').style.display = d.shape==='rect'?'block':'none'; 
                document.getElementById('pRadius').value=d.radius;
            } else {
                document.getElementById('propsShape').classList.add('hidden'); document.getElementById('propsText').classList.remove('hidden');
                document.getElementById('lblText').innerText=d.type==='input'?'Placeholder':'Content';
                document.getElementById('pTxt').value=d.type==='input'?d.placeholder:d.text;
                document.getElementById('pFont').value=d.font; document.getElementById('pColor').value=d.color; document.getElementById('pSize').value=d.size;
                document.getElementById('btnBold').classList.toggle('active',d.bold); document.getElementById('btnItalic').classList.toggle('active',d.italic); document.getElementById('btnShadow').classList.toggle('active',d.shadow);
            }
        }

        function upd(p,v) {
            if(!selId)return; const d=els.find(x=>x.id===selId), el=document.getElementById(selId);
            if(p==='op')d.op=v; 
            if(p==='fill')d.fill=v; 
            if(p==='shape') { d.shape=v; document.getElementById('radiusContainer').style.display = v==='rect'?'block':'none'; }
            if(p==='radius') d.radius=v;
            if(p==='text'){ d.type==='input'?d.placeholder=v:d.text=v; el.innerHTML=d.type==='input'?`[${v}]`:v; const h=document.createElement('div'); h.className='handle'; el.appendChild(h); h.onmousedown=(e)=>resize(e,d.id); }
            if(['font','color','size','align'].includes(p))d[p]=v;
            applyCSS(el,d);
        }
        function toggleStyle(s){ if(!selId)return; const d=els.find(x=>x.id===selId); d[s]=!d[s]; document.getElementById('btn'+s.charAt(0).toUpperCase()+s.slice(1)).classList.toggle('active',d[s]); applyCSS(document.getElementById(selId),d); }

        function del(){ if(selId){ document.getElementById(selId).remove(); els=els.filter(x=>x.id!==selId); selId=null; document.getElementById('props').classList.add('hidden'); updateLayers(); }}
        function clearCanvas(){ if(confirm('Clear?')){document.querySelectorAll('.el').forEach(e=>e.remove()); els=[]; selId=null; updateLayers();} }

        function updateLayers() {
            const l=document.getElementById('layerList'); l.innerHTML='';
            [...els].sort((a,b)=>b.z-a.z).forEach(el=>{
                const i=document.createElement('div'); i.className=`layer-item ${selId===el.id?'active':''}`; i.id=`layer_${el.id}`; i.draggable=true;
                i.innerHTML=`<span>${el.type==='photo'?'üì∑ Photo':'T Text'}</span>`;
                i.onclick=()=>select(el.id);
                i.ondragstart=(e)=>{e.dataTransfer.setData('id',el.id);};
                l.appendChild(i);
            });
            l.ondragover=(e)=>e.preventDefault();
            l.ondrop=(e)=>{ 
                const id=e.dataTransfer.getData('id'); const d=els.find(x=>x.id===id); d.z=Math.max(...els.map(x=>x.z))+1; document.getElementById(id).style.zIndex=d.z; updateLayers();
            };
        }

        function launch() {
            const t=document.getElementById('campTitle').value, bg=document.getElementById('bgImg').src, desc=document.getElementById('campDesc').value;
            if(!bg || bg===window.location.href) return alert("Background required");
            const all=JSON.parse(localStorage.getItem('allCampaigns'))||[];
            const cDat = { id:editingId||'c_'+Date.now(), title:t, desc:desc, client:user.name, image:bg, elements:els, active:true };
            if(editingId){ const i=all.findIndex(x=>x.id===editingId); if(i!==-1)all[i]=cDat; } else all.push(cDat);
            try{ localStorage.setItem('allCampaigns',JSON.stringify(all)); alert('Saved!'); switchView('list'); } catch(e){alert('Storage Full');}
        }

        function loadCampaigns() {
            const all=JSON.parse(localStorage.getItem('allCampaigns'))||[], my=all.filter(c=>c.client===user.name), g=document.getElementById('campGrid');
            g.innerHTML=''; if(my.length===0)g.innerHTML='<div class="empty-msg">No campaigns.</div>';
            my.forEach(c=>{
                const i=all.findIndex(x=>x.id===c.id);
                g.innerHTML+=`<div class="camp-card"><div class="card-img"><img src="${c.image}"><span class="status-badge" style="color:${c.active!==false?'green':'gray'}">‚óè ${c.active!==false?'Active':'Inactive'}</span></div><div class="card-body"><div class="card-title">${c.title}</div><div class="card-actions"><button class="btn-act" onclick="editCamp(${i})">Edit</button><button class="btn-act" onclick="toggle(${i})">Toggle</button><button class="btn-act btn-share" onclick="copyLink('${c.id}')">üîó Link</button><button class="btn-act btn-del" onclick="delCamp(${i})">Del</button></div></div></div>`;
            });
        }
        function editCamp(i){ const c=JSON.parse(localStorage.getItem('allCampaigns'))[i]; editingId=c.id; document.getElementById('campTitle').value=c.title; document.getElementById('campDesc').value=c.desc||''; els=c.elements; const img=new Image(); img.src=c.image; document.getElementById('btnLaunchText').innerText="üíæ Update"; img.onload=()=>{ document.getElementById('bgImg').src=c.image; document.getElementById('bgImg').style.display='block'; document.getElementById('artboard').style.width='450px'; document.getElementById('artboard').style.height=(450*(img.height/img.width))+'px'; }; document.querySelectorAll('.el').forEach(e=>e.remove()); els.forEach(render); updateLayers(); switchView('editor'); }
        function toggle(i){ const all=JSON.parse(localStorage.getItem('allCampaigns')); all[i].active=!all[i].active; localStorage.setItem('allCampaigns',JSON.stringify(all)); loadCampaigns(); }
        function delCamp(i){ if(confirm('Delete?')){ const all=JSON.parse(localStorage.getItem('allCampaigns')); all.splice(i,1); localStorage.setItem('allCampaigns',JSON.stringify(all)); loadCampaigns(); } }
        function copyLink(id){ const link = window.location.href.replace('dashboard.html','generate.html?id='+id); navigator.clipboard.writeText(link).then(()=>alert('Link Copied: '+link)); }
        function resetData() { if(confirm("CLEAR ALL STORAGE?")) { localStorage.removeItem('allCampaigns'); alert("Reset Done."); location.reload(); } }

        function loadProfile(){ document.getElementById('profName').value=user.name; document.getElementById('profEmail').value=user.email; document.getElementById('profPass').value=user.pass; }
        function saveProfile(){ user.name=document.getElementById('profName').value; user.pass=document.getElementById('profPass').value; localStorage.setItem('clientAccount',JSON.stringify(user)); alert('Saved'); }
        
        // INIT VIEW
        switchView('list');
    </script>
</body>
</html>