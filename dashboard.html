<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Studio | PosterBox</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Lobster&family=Montserrat:wght@700&family=Oswald:wght@500&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary: #4f46e5; --bg: #f3f4f6; --surface: #ffffff; --border: #e5e7eb; --danger: #ef4444; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* --- NAVIGATION --- */
        /* Mobile Nav (Top Bar) */
        .mob-nav { background: #1e1b4b; color: white; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; z-index: 100; flex-shrink: 0; }
        .mob-brand { font-weight: 800; font-size: 1.1rem; display: flex; align-items: center; gap: 8px; }
        .mob-menu { display: flex; gap: 20px; }
        .mob-icon { font-size: 1.2rem; cursor: pointer; opacity: 0.7; transition: 0.2s; }
        .mob-icon.active { opacity: 1; color: #a5b4fc; }
        
        /* Desktop Rail (Hidden on Mobile) */
        .desktop-rail { display: none; }

        /* --- LAYOUT --- */
        .app-body { flex: 1; position: relative; overflow: hidden; }
        .view-section { position: absolute; inset: 0; background: var(--bg); display: flex; flex-direction: column; transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); pointer-events: none; opacity: 0; }
        .view-section.active { transform: translateX(0); pointer-events: auto; opacity: 1; }

        /* --- LIST VIEW --- */
        #view-list { overflow-y: auto; padding: 20px; }
        .list-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .btn-new { background: var(--primary); color: white; border: none; padding: 10px 16px; border-radius: 8px; font-weight: 700; cursor: pointer; box-shadow: 0 4px 10px rgba(79, 70, 229, 0.3); }
        
        .grid { display: grid; grid-template-columns: 1fr; gap: 15px; padding-bottom: 40px; }
        .camp-card { background: white; border-radius: 12px; overflow: hidden; border: 1px solid var(--border); display: flex; height: 100px; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .camp-img { width: 100px; height: 100%; background: #eee; object-fit: cover; }
        .camp-info { flex: 1; padding: 12px; display: flex; flex-direction: column; justify-content: center; }
        .camp-title { font-weight: 700; margin-bottom: 5px; font-size: 1rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .camp-actions { margin-top: auto; display: flex; gap: 10px; }
        .btn-sm { font-size: 0.75rem; padding: 5px 10px; border-radius: 4px; border: 1px solid var(--border); background: white; cursor: pointer; }

        /* --- EDITOR VIEW --- */
        .editor-container { display: flex; flex-direction: column; height: 100%; }
        
        /* Top Bar */
        .editor-header { background: white; padding: 10px 15px; border-bottom: 1px solid var(--border); display: flex; gap: 10px; align-items: center; justify-content: space-between; flex-shrink: 0; }
        .input-title { border: 1px solid transparent; font-weight: 700; font-size: 1rem; width: 100%; padding: 5px; border-radius: 4px; }
        .input-title:focus { border-color: var(--primary); outline: none; }
        
        /* Canvas Area */
        .stage { flex: 1; background: #e5e7eb; position: relative; overflow: hidden; background-image: radial-gradient(#cbd5e1 1px, transparent 1px); background-size: 20px 20px; touch-action: none; display: flex; align-items: center; justify-content: center; }
        
        /* The Poster */
        .artboard { width: 300px; height: 400px; background: white; box-shadow: 0 20px 50px rgba(0,0,0,0.15); position: relative; overflow: hidden; transition: transform 0.2s; }
        .bg-layer { width: 100%; height: 100%; object-fit: cover; pointer-events: none; user-select: none; }

        /* Tools Panel (Bottom Sheet) */
        .tools-panel { height: 35%; background: white; border-top: 1px solid var(--border); display: flex; flex-direction: column; z-index: 10; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); }
        .tools-scroll { overflow-y: auto; padding: 15px; flex: 1; }
        
        /* Tool Buttons */
        .tool-row { display: flex; gap: 10px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 5px; }
        .tool-btn { flex: 0 0 auto; padding: 10px 16px; background: #f8fafc; border: 1px solid var(--border); border-radius: 8px; font-weight: 600; font-size: 0.85rem; color: #334155; display: flex; align-items: center; gap: 6px; cursor: pointer; }
        .tool-btn:active { background: #eef2ff; border-color: var(--primary); color: var(--primary); }

        /* Properties (Contextual) */
        #props { display: none; border-top: 1px solid #f1f5f9; padding-top: 15px; animation: slideUp 0.2s; }
        @keyframes slideUp { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .prop-group { margin-bottom: 10px; }
        .prop-label { font-size: 0.7rem; text-transform: uppercase; font-weight: 700; color: #94a3b8; margin-bottom: 5px; display: block; }
        .prop-input { width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; font-size: 0.9rem; }
        .btn-del { width: 100%; background: #fef2f2; color: var(--danger); border: 1px solid #fecaca; padding: 10px; border-radius: 6px; font-weight: 700; margin-top: 10px; }

        /* --- ELEMENTS ON CANVAS --- */
        .el { position: absolute; border: 1px dashed transparent; display: flex; align-items: center; justify-content: center; box-sizing: border-box; touch-action: none; }
        .el.selected { border: 1px solid var(--primary); z-index: 100 !important; }
        
        /* Handles */
        .handle { width: 20px; height: 20px; background: white; border: 1px solid var(--primary); border-radius: 50%; position: absolute; display: none; z-index: 101; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .el.selected .handle { display: block; }
        .h-br { bottom: -10px; right: -10px; } /* Resize */
        .h-rot { top: -25px; left: 50%; transform: translateX(-50%); background: var(--primary); color: white; border: none; font-size: 12px; display: flex; align-items: center; justify-content: center; } /* Rotate */

        /* DESKTOP OVERRIDES */
        @media (min-width: 900px) {
            body { flex-direction: row; }
            .mob-nav { display: none; }
            .desktop-rail { display: flex; width: 70px; background: #1e1b4b; flex-direction: column; align-items: center; padding: 20px 0; color: white; }
            .rail-icon { font-size: 1.5rem; margin-bottom: 20px; cursor: pointer; opacity: 0.7; width: 40px; height: 40px; display: grid; place-items: center; border-radius: 8px; }
            .rail-icon:hover { background: rgba(255,255,255,0.1); opacity: 1; }
            .rail-icon.active { background: var(--primary); opacity: 1; }
            
            .grid { grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); }
            .camp-card { flex-direction: column; height: auto; }
            .camp-img { width: 100%; height: 160px; }
            
            .editor-container { flex-direction: row; }
            .stage { height: auto; }
            .tools-panel { width: 320px; height: auto; border-top: none; border-left: 1px solid var(--border); }
        }
    </style>
</head>
<body>

    <div class="mob-nav">
        <div class="mob-brand"><span>P</span> Studio</div>
        <div class="mob-menu">
            <div class="mob-icon active" id="m-list" onclick="window.switchView('list')">üìÇ</div>
            <div class="mob-icon" id="m-edit" onclick="window.switchView('editor')">üé®</div>
            <div class="mob-icon" onclick="window.logout()">üö™</div>
        </div>
    </div>

    <div class="desktop-rail">
        <div class="rail-icon active" id="d-list" onclick="window.switchView('list')">üìÇ</div>
        <div class="rail-icon" id="d-edit" onclick="window.switchView('editor')">üé®</div>
        <div class="rail-icon" style="margin-top:auto;" onclick="window.logout()">üö™</div>
    </div>

    <div class="app-body">
        
        <div id="view-list" class="view-section active">
            <div class="list-header">
                <h1 style="font-size:1.5rem; margin:0;">My Campaigns</h1>
                <button class="btn-new" onclick="window.createNew()">+ New</button>
            </div>
            <div id="campGrid" class="grid">
                <div style="text-align:center; color:#94a3b8; padding:40px;">Loading...</div>
            </div>
        </div>

        <div id="view-editor" class="view-section">
            <div class="editor-container">
                
                <div class="editor-header">
                    <input type="text" id="campTitle" value="Untitled Campaign" class="input-title">
                    <button class="btn-new" id="btnSave" onclick="window.launch()" style="padding:8px 12px; font-size:0.9rem;">Save</button>
                </div>

                <div class="stage" id="stageArea" onclick="window.deselect()">
                    <div id="artboard" class="artboard">
                        <img id="bgImg" class="bg-layer" style="display:none;">
                    </div>
                </div>

                <div class="tools-panel">
                    <div class="tools-scroll">
                        <label class="prop-label">Add Elements</label>
                        <div class="tool-row">
                            <button class="tool-btn" onclick="document.getElementById('bgUp').click()">üñºÔ∏è BG</button>
                            <button class="tool-btn" onclick="window.add('photo')">üì∑ Photo</button>
                            <button class="tool-btn" onclick="window.add('text')">TXT Text</button>
                            <button class="tool-btn" onclick="window.add('input')">‚úçÔ∏è Input</button>
                        </div>
                        
                        <div id="props">
                            <label class="prop-label">Edit Selected</label>
                            
                            <div class="prop-group">
                                <input type="text" id="pTxt" class="prop-input" placeholder="Text Content" oninput="window.upd('text', this.value)">
                            </div>
                            
                            <div style="display:flex; gap:10px;">
                                <div style="flex:1;">
                                    <label class="prop-label">Size</label>
                                    <input type="range" id="pSize" min="10" max="100" style="width:100%" oninput="window.upd('size', this.value)">
                                </div>
                                <div style="flex:1;">
                                    <label class="prop-label">Color</label>
                                    <input type="color" id="pColor" style="width:100%; height:30px; border:none;" oninput="window.upd('color', this.value)">
                                </div>
                            </div>

                            <button class="btn-del" onclick="window.del()">Delete Element</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <input type="file" id="bgUp" style="display:none;" accept="image/*" onchange="window.uploadBg(event)">

    <script src="db.js"></script>

    <script>
        // --- STATE ---
        let user;
        let els = [], selId = null, editingId = null;
        let scale = 1;

        // --- INIT ---
        try { user = JSON.parse(localStorage.getItem('clientAccount')); } catch(e){}
        if(!user) window.location.href='login.html';

        // --- NAVIGATION ---
        window.switchView = function(view) {
            // Toggle Views
            document.querySelectorAll('.view-section').forEach(e => e.classList.remove('active'));
            document.getElementById('view-' + view).classList.add('active');
            
            // Toggle Icons
            document.querySelectorAll('.mob-icon, .rail-icon').forEach(e => e.classList.remove('active'));
            if(document.getElementById('m-'+(view==='list'?'list':'edit'))) document.getElementById('m-'+(view==='list'?'list':'edit')).classList.add('active');
            if(document.getElementById('d-'+(view==='list'?'list':'edit'))) document.getElementById('d-'+(view==='list'?'list':'edit')).classList.add('active');

            if(view === 'list') loadCampaigns();
        };

        window.logout = function() {
            localStorage.removeItem('isLoggedIn');
            window.location.href = 'index.html';
        };

        // --- DATA ---
        async function loadCampaigns() {
            const all = await window.getAllCampaigns();
            const my = all.filter(c => c.client === user.name);
            const grid = document.getElementById('campGrid');
            
            if(my.length === 0) {
                grid.innerHTML = '<div style="text-align:center; color:#94a3b8; padding:40px;">No campaigns yet.<br>Tap "+ New" to start.</div>';
                return;
            }

            grid.innerHTML = my.map((c, i) => `
                <div class="camp-card">
                    <img src="${c.image}" class="camp-img" crossorigin="anonymous">
                    <div class="camp-info">
                        <div class="camp-title">${c.title}</div>
                        <div class="camp-actions">
                            <button class="btn-sm" onclick="window.editCamp(${i})">Edit</button>
                            <button class="btn-sm" style="color:red; border-color:#fecaca;" onclick="window.delCamp(${i})">Del</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // --- EDITOR LOGIC ---
        window.createNew = function() {
            editingId = null; els = []; selId = null;
            document.getElementById('campTitle').value = "Untitled Campaign";
            document.getElementById('bgImg').src = "";
            document.getElementById('bgImg').style.display = "none";
            document.getElementById('props').style.display = "none";
            document.querySelectorAll('.el').forEach(e => e.remove());
            window.switchView('editor');
        };

        window.editCamp = async function(i) {
            const all = await window.getAllCampaigns();
            const my = all.filter(c => c.client === user.name);
            const c = my[i];
            
            editingId = c.id;
            els = c.elements;
            document.getElementById('campTitle').value = c.title;
            document.getElementById('bgImg').src = c.image;
            document.getElementById('bgImg').style.display = "block";
            
            document.querySelectorAll('.el').forEach(e => e.remove());
            els.forEach(renderEl);
            window.switchView('editor');
        };

        window.uploadBg = function(e) {
            const f = e.target.files[0]; if(!f) return;
            const r = new FileReader();
            r.onload = (ev) => {
                document.getElementById('bgImg').src = ev.target.result;
                document.getElementById('bgImg').style.display = 'block';
            };
            r.readAsDataURL(f);
        };

        window.add = function(type) {
            const id = 'el_' + Date.now();
            const d = { 
                id, type, 
                x: 50, y: 50, w: 100, h: 50, 
                text: type==='text'?'Text':'Input', 
                size: 20, color: '#000000', rot: 0 
            };
            els.push(d); renderEl(d); select(id);
        };

        function renderEl(d) {
            const div = document.createElement('div');
            div.id = d.id; div.className = 'el';
            applyCSS(div, d);

            // Resize Handle
            const rh = document.createElement('div'); rh.className = 'handle h-br';
            div.appendChild(rh);
            
            // Rotate Handle
            const rot = document.createElement('div'); rot.className = 'handle h-rot';
            rot.innerHTML = '‚Üª';
            div.appendChild(rot);

            // Touch/Mouse Events
            addInteractions(div, d, rh, rot);
            
            document.getElementById('artboard').appendChild(div);
        }

        function applyCSS(div, d) {
            div.style.left = d.x + 'px'; div.style.top = d.y + 'px';
            div.style.width = d.w + 'px'; div.style.height = d.h + 'px';
            div.style.transform = `rotate(${d.rot || 0}deg)`;
            
            if(d.type === 'photo') {
                div.style.background = '#e0e7ff';
                div.innerHTML = `<span style="pointer-events:none">üì∑</span>`;
                div.style.borderRadius = '8px';
            } else {
                div.innerText = d.type==='input' ? `[${d.text}]` : d.text;
                div.style.fontSize = d.size + 'px';
                div.style.color = d.color;
                div.style.fontFamily = 'Inter';
            }
            // Re-append handles after setting innerHTML
            if(!div.querySelector('.handle')) {
                const rh = document.createElement('div'); rh.className = 'handle h-br';
                const rot = document.createElement('div'); rot.className = 'handle h-rot'; rot.innerHTML = '‚Üª';
                div.appendChild(rh); div.appendChild(rot);
                addInteractions(div, d, rh, rot);
            }
        }

        function select(id) {
            selId = id;
            document.querySelectorAll('.el').forEach(e => e.classList.remove('selected'));
            const el = document.getElementById(id);
            if(el) el.classList.add('selected');
            
            // Show Props
            document.getElementById('props').style.display = 'block';
            const d = els.find(e => e.id === id);
            
            // Sync Inputs
            if(d) {
                document.getElementById('pTxt').value = d.text || '';
                document.getElementById('pSize').value = d.size || 20;
                document.getElementById('pColor').value = d.color || '#000000';
            }
        }

        window.deselect = function(e) {
            if(e && e.target.id === 'stageArea') {
                selId = null;
                document.querySelectorAll('.el').forEach(e => e.classList.remove('selected'));
                document.getElementById('props').style.display = 'none';
            }
        };

        window.upd = function(key, val) {
            if(!selId) return;
            const d = els.find(e => e.id === selId);
            const el = document.getElementById(selId);
            
            if(key === 'text') d.text = val;
            if(key === 'size') d.size = parseInt(val);
            if(key === 'color') d.color = val;
            
            applyCSS(el, d);
        };

        window.del = function() {
            if(selId) {
                document.getElementById(selId).remove();
                els = els.filter(e => e.id !== selId);
                selId = null;
                document.getElementById('props').style.display = 'none';
            }
        };

        // --- INTERACTIONS (Touch + Mouse) ---
        function addInteractions(div, d, rh, rot) {
            let startX, startY, startLeft, startTop, startW, startH, startRot, startAngle;

            // Drag Main
            const startDrag = (e) => {
                if(e.target.className.includes('handle')) return;
                e.preventDefault(); e.stopPropagation();
                select(d.id);
                const pt = e.touches ? e.touches[0] : e;
                startX = pt.clientX; startY = pt.clientY;
                startLeft = d.x; startTop = d.y;
                document.addEventListener(e.touches?'touchmove':'mousemove', doDrag);
                document.addEventListener(e.touches?'touchend':'mouseup', stopDrag);
            };
            const doDrag = (e) => {
                const pt = e.touches ? e.touches[0] : e;
                d.x = startLeft + (pt.clientX - startX);
                d.y = startTop + (pt.clientY - startY);
                applyCSS(div, d);
            };
            const stopDrag = () => {
                document.removeEventListener('touchmove', doDrag); document.removeEventListener('mousemove', doDrag);
            };

            // Resize Handle
            const startResize = (e) => {
                e.preventDefault(); e.stopPropagation();
                const pt = e.touches ? e.touches[0] : e;
                startX = pt.clientX; startY = pt.clientY;
                startW = d.w; startH = d.h;
                document.addEventListener(e.touches?'touchmove':'mousemove', doResize);
                document.addEventListener(e.touches?'touchend':'mouseup', stopResize);
            };
            const doResize = (e) => {
                const pt = e.touches ? e.touches[0] : e;
                d.w = Math.max(30, startW + (pt.clientX - startX));
                d.h = Math.max(30, startH + (pt.clientY - startY));
                applyCSS(div, d);
            };
            const stopResize = () => {
                document.removeEventListener('touchmove', doResize); document.removeEventListener('mousemove', doResize);
            };

            // Rotate Handle
            const startRotate = (e) => {
                e.preventDefault(); e.stopPropagation();
                const pt = e.touches ? e.touches[0] : e;
                const rect = div.getBoundingClientRect();
                const cx = rect.left + rect.width/2;
                const cy = rect.top + rect.height/2;
                startAngle = Math.atan2(pt.clientY - cy, pt.clientX - cx);
                startRot = d.rot || 0;
                document.addEventListener(e.touches?'touchmove':'mousemove', (ev) => doRotate(ev, cx, cy));
                document.addEventListener(e.touches?'touchend':'mouseup', stopRotate);
            };
            const doRotate = (e, cx, cy) => {
                const pt = e.touches ? e.touches[0] : e;
                const angle = Math.atan2(pt.clientY - cy, pt.clientX - cx);
                const deg = (angle - startAngle) * (180/Math.PI);
                d.rot = startRot + deg;
                applyCSS(div, d);
            };
            const stopRotate = () => {
                // Simplified cleanup
            };

            div.addEventListener('mousedown', startDrag); div.addEventListener('touchstart', startDrag);
            rh.addEventListener('mousedown', startResize); rh.addEventListener('touchstart', startResize);
            rot.addEventListener('mousedown', startRotate); rot.addEventListener('touchstart', startRotate);
        }

        // --- CLOUD ---
        window.launch = async function() {
            const btn = document.getElementById('btnSave');
            btn.innerText = "Saving...";
            
            const data = {
                id: editingId || 'c_' + Date.now(),
                title: document.getElementById('campTitle').value,
                image: document.getElementById('bgImg').src,
                elements: els,
                client: user.name,
                active: true
            };

            const success = await window.saveCampaignToCloud(data);
            if(success) {
                alert("Saved!");
                window.switchView('list');
            } else {
                alert("Error saving.");
            }
            btn.innerText = "Save";
        };

        window.delCamp = async function(i) {
            if(confirm("Delete this campaign?")) {
                const all = await window.getAllCampaigns();
                const my = all.filter(c => c.client === user.name);
                await window.deleteCampaignCloud(my[i].id);
                loadCampaigns();
            }
        };

        // START
        window.switchView('list');
    </script>
</body>
</html>