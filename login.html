<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Login | PosterBox</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script src="./db.js"></script> 

    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { margin:0; font-family:'Plus Jakarta Sans', sans-serif; height:100vh; display:flex; overflow:hidden; }
        .visual-side { flex:1; background: linear-gradient(135deg, #4f46e5 0%, #3b82f6 100%); display:flex; align-items:center; justify-content:center; color:white; flex-direction:column; padding:40px; }
        .visual-side h1 { font-size:3rem; margin:0 0 20px 0; }
        .visual-side p { font-size:1.2rem; opacity:0.9; max-width:400px; text-align:center; line-height:1.6; }
        .form-side { width:500px; background:white; padding:60px; display:flex; flex-direction:column; justify-content:center; overflow-y:auto; position: relative; }
        .tabs { display:flex; border-bottom:1px solid #e2e8f0; margin-bottom:30px; }
        .tab { padding:15px 0; margin-right:20px; cursor:pointer; font-weight:600; color:#64748b; border-bottom:2px solid transparent; transition:0.3s; }
        .tab.active { color:#4f46e5; border-bottom-color:#4f46e5; }
        .input-group { margin-bottom:20px; }
        label { display:block; font-size:0.875rem; font-weight:700; color:#1e293b; margin-bottom:8px; }
        input { width:100%; padding:14px; border:1px solid #cbd5e1; border-radius:8px; font-size:1rem; outline:none; transition:0.2s; box-sizing:border-box; }
        input:focus { border-color:#4f46e5; box-shadow:0 0 0 3px rgba(79, 70, 229, 0.1); }
        .btn { width:100%; padding:16px; background:#4f46e5; color:white; border:none; border-radius:8px; font-weight:700; font-size:1rem; cursor:pointer; transition:0.2s; margin-top:10px; }
        .btn:hover { background:#4338ca; }
        .hidden { display:none; }
        @media(max-width:900px) { .visual-side { display:none; } .form-side { width:100%; } }
    </style>
</head>
<body>

    <div class="visual-side">
        <h1>PosterBox</h1>
        <p>Empower your movement with professional campaign tools. Create templates, share links, and go viral.</p>
    </div>

    <div class="form-side">
        <div style="margin-bottom:40px;">
            <h2 style="margin:0; font-size:1.8rem;">Welcome Back</h2>
            <p style="color:#64748b; margin-top:5px;">Please enter your details to continue.</p>
        </div>

        <div id="error-msg" style="display:none; padding:15px; background:#fee2e2; color:#ef4444; border-radius:8px; margin-bottom:20px; font-weight:bold;"></div>

        <div class="tabs">
            <div class="tab active" id="tab-login" onclick="window.setMode('login')">Log In</div>
            <div class="tab" id="tab-signup" onclick="window.setMode('signup')">Create Account</div>
        </div>

        <div id="loginForm">
            <div class="input-group"><label>Email Address</label><input type="email" id="lEmail" placeholder="email@example.com"></div>
            <div class="input-group"><label>Password</label><input type="password" id="lPass" placeholder="••••••••"></div>
            <button class="btn" onclick="window.login()">Access Dashboard</button>
        </div>

        <div id="signupForm" class="hidden">
            <div class="input-group"><label>Organization Name</label><input type="text" id="sName" placeholder="Your Name"></div>
            <div class="input-group"><label>Email Address</label><input type="email" id="sEmail" placeholder="email@example.com"></div>
            <div class="input-group"><label>Username</label><input type="text" id="sUser" placeholder="username"></div>
            <div class="input-group"><label>Password</label><input type="password" id="sPass" placeholder="Create a password"></div>
            <button class="btn" onclick="window.signup()">Register Organization</button>
        </div>
        
        <div style="margin-top:30px; text-align:center;">
            <a href="index.html" style="color:#64748b; text-decoration:none; font-size:0.9rem;">← Back to Homepage</a>
        </div>
    </div>

    <script>
        // DIAGNOSTIC CHECK
        window.onload = function() {
            if (typeof window.registerUserCloud !== 'function') {
                const msg = document.getElementById('error-msg');
                msg.style.display = 'block';
                msg.innerText = "CRITICAL ERROR: db.js failed to load. Please check if 'db.js' is in your GitHub repository.";
            }
        };

        window.setMode = function(mode) {
            document.getElementById('loginForm').style.display = mode === 'login' ? 'block' : 'none';
            document.getElementById('signupForm').style.display = mode === 'signup' ? 'block' : 'none';
            document.getElementById('tab-login').classList.toggle('active', mode === 'login');
            document.getElementById('tab-signup').classList.toggle('active', mode === 'signup');
        }

        window.signup = async function() {
            const name = document.getElementById('sName').value;
            const email = document.getElementById('sEmail').value;
            const user = document.getElementById('sUser').value;
            const pass = document.getElementById('sPass').value;

            if (!email || !pass) return alert("All fields are required.");

            const btn = document.querySelector('#signupForm .btn');
            btn.innerText = "Creating...";

            try {
                // Check if db.js loaded
                if(typeof window.registerUserCloud !== 'function') throw new Error("Database not connected. Refresh the page.");

                const acc = { name, email, user, pass, verified: false, tier: 'free', banned: false };
                const result = await window.registerUserCloud(acc);
                
                if (result.success) {
                    localStorage.setItem('clientAccount', JSON.stringify(acc));
                    localStorage.setItem('isLoggedIn', 'true');
                    window.location.href = 'dashboard.html';
                } else {
                    btn.innerText = "Register Organization";
                    alert("Error: " + result.message);
                }
            } catch (e) {
                btn.innerText = "Register Organization";
                alert(e.message);
            }
        }

        window.login = async function() {
            const email = document.getElementById('lEmail').value;
            const pass = document.getElementById('lPass').value;
            
            const btn = document.querySelector('#loginForm .btn');
            btn.innerText = "Checking...";

            try {
                if(typeof window.loginUserCloud !== 'function') throw new Error("Database not connected. Refresh the page.");

                const result = await window.loginUserCloud(email, pass);

                if (result.success) {
                    if (result.user.banned) return alert("Account Suspended.");
                    localStorage.setItem('clientAccount', JSON.stringify(result.user));
                    localStorage.setItem('isLoggedIn', 'true');
                    window.location.href = 'dashboard.html';
                } else {
                    btn.innerText = "Access Dashboard";
                    alert(result.message);
                }
            } catch (e) {
                btn.innerText = "Access Dashboard";
                alert(e.message);
            }
        }
    </script>
</body>
</html>